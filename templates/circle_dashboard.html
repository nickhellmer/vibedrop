{% extends "base.html" %}
{% block title %}{{ circle.circle_name }} - VibeDrop{% endblock %}

{% block extra_css %}
<style>
  /* Tighter ghost-danger for inline, texty actions */
  .btn.ghost.danger.xs { padding: 2px 4px; font-size: .4rem; }
  /* Slightly softer hover for subtlety */
  .btn.ghost.danger.xs:hover { background: rgba(255,77,79,0.06); }
</style>
<style>
  /* Hidden by default */
  #members-section .owner-remove { 
    display: none; 
    margin-left: 8px; 
  }

  /* When editing is on, reveal remove controls */
  #members-section.editing .owner-remove {
    display: inline-block;
  }

  /* Tiny pill ‚Äî you can keep your ultra‚Äësmall tweak */
  .btn.ghost.danger.xs { padding: 2px 4px; font-size: .4rem; }
</style>
<style>
  .track-link {
    color: var(--text);
    text-decoration: none;
    display: inline-block;
    max-width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .track-link:hover {
    text-decoration: underline;
  }

  .track-link .truncate {
    display: inline-block;
    vertical-align: middle;
  }
</style>
{% endblock %}

{% block content %}
{% set is_owner = (circle.creator_id == user_id) %}

<div class="topbar">
  <h1 class="page-title">{{ circle.circle_name }}</h1>
</div>

<div class="stack">

    <!-- META CARD: CIRCLE INFO AND ACTIONS -->
    <section class="card">
      <div class="row between">
        <!-- Left: Meta grid -->
        <div class="meta-grid">
          <div class="kv">
            <span class="k">Drop Frequency</span>
            <span class="v chip">{{ circle.drop_frequency }}</span>
          </div>
    
          <div class="kv">
            <span class="k">Drop Time</span>
            <span class="v chip">{{ circle.drop_time | to_est | datetimeformat('%I:%M %p EST') }}</span>
          </div>
    
          <div class="kv">
            <span class="k">Drop Day(s)</span>
            <span class="v chip">
              {% if circle.drop_frequency == 'Weekly' %}
                {{ circle.drop_day1 }}
              {% elif circle.drop_frequency == 'Biweekly' %}
                {{ circle.drop_day1 }} &nbsp;&amp;&nbsp; {{ circle.drop_day2 }}
              {% else %}
                ‚Äî
              {% endif %}
            </span>
          </div>
    
          <div class="kv">
            <span class="k">Invite Code</span>
            <span class="v">
              <span class="code-pill" id="invite-code">{{ circle.invite_code }}</span>
              <button class="icon-button sm" type="button" title="Copy invite code" aria-label="Copy invite code"
                      onclick="copyInviteCode()">üìã</button>
            </span>
          </div>
        </div>
    
        <!-- Actions / Buttons -->
        <div class="row">
          <a class="btn sm equal" href="{{ url_for('submit_song', circle_id=circle.id) }}">Submit a Vibe</a>
        
          {% if previous_submissions %}
            <button type="button" class="btn xs equal" onclick="createPlaylist()">Create & Open Playlist</button>
          {% endif %}
          {% if is_owner %}
            <a class="btn ghost sm equal" href="{{ url_for('edit_circle', circle_id=circle.id) }}">Edit Circle</a>
            <button type="button" class="btn ghost sm equal" id="toggle-edit-members"
                    aria-pressed="false" aria-controls="members-section">Edit members</button>
            <form action="{{ url_for('delete_circle', circle_id=circle.id) }}" method="POST"
                    onsubmit="return confirm('Are you sure you want to delete this Sound Circle? This cannot be undone.');">
            <button type="submit" class="btn ghost danger sm equal">Delete Circle</button>
            </form>
          {% endif %}

          {% if not is_owner %}
              <form action="{{ url_for('leave_circle') }}" method="POST"
                    onsubmit="return confirm('Leave this Sound Circle? You can rejoin later with the invite code.');">
                <input type="hidden" name="circle_id" value="{{ circle.id }}">
                <button type="submit" class="btn ghost danger sm equal">Leave Circle</button>
              </form>
          {% endif %}
        </div>
      </div>
    </section>

  <!-- MEMBERS -->
  <section class="card flex" id="members-section">
    <h2 class="h2-tight">Members</h2>
    {% if members and members|length > 0 %}
      <div class="table-viewport flex grow" style="max-height: calc((100vh - 260px) / 2);">
        <table class="table table--compact sortable">
          <thead>
            <tr>
              <th data-type="text">Username</th>
              <th class="col-narrow" data-type="text">Submitted This Cycle?</th>
            </tr>
          </thead>
          <tbody>
            {% for member in members %}
              <tr>
                <td>
                  {{ member.vibedrop_username }}
                  {% if is_owner and member.id != user_id %}
                    <form action="{{ url_for('remove_member', circle_id=circle.id, user_id=member.id) }}" 
                          method="POST"
                          class="owner-remove"
                          onsubmit="return confirm('Remove {{ member.vibedrop_username }} from the Sound Circle?');">
                      <button type="submit" class="btn ghost danger xs" aria-label="Remove {{ member.vibedrop_username }}">Remove</button>
                    </form>
                  {% endif %}
                </td>
                <td>
                  {% if member.id in submitted_user_ids %}
                    ‚úÖ
                  {% else %}
                    ‚ùå
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="subtle">No members yet.</p>
    {% endif %}
  </section>

  <!-- TESTING-MODE SUBMISSIONS (current cycle, visible only in testing mode) -->
  {% if testing_mode %}
    <section class="card">
      <div class="row" style="justify-content: space-between; align-items: baseline;">
        <h2 class="h2-tight">Submitted Vibes (Testing Mode Only)</h2>
      </div>

      {% if submissions %}
        <div class="table-viewport flex grow" style="max-height: calc((100vh - 260px) / 3);">
          <table class="table table--compact sortable">
            <thead>
              <tr>
                <th>Vibe Name</th>
                <th>Vibe Artist</th>
                <th class="col-narrow">Submitted On</th>
              </tr>
            </thead>
            <tbody>
              {% for submission in submissions %}
                <tr>
                  <td><span class="truncate">{{ submission.track_name or "Unknown Title" }}</span></td>
                  <td><span class="truncate">{{ submission.track_artist or "Unknown Artist" }}</span></td>
                  <td>{{ submission.submitted_at | to_est | datetimeformat('%b %d, %Y at %I:%M %p EST') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="subtle">No submissions yet.</p>
      {% endif %}
    </section>
  {% endif %}

    <!-- FRESH FROM THE DROP (rate last finalized cycle) -->
    <section class="card flex">
      <div class="row" style="justify-content: space-between; align-items: baseline;">
        <h2 class="h2-tight">Fresh From the Drop</h2>
        {% if previous_submissions %}
          <button type="button" class="btn" onclick="createPlaylist()">Create & Open Playlist in Spotify</button>
        {% endif %}
      </div>
    
      {% if previous_submissions %}
        <div class="table-viewport flex grow mt-10" style="max-height: calc((100vh - 260px) / 2);">
          <table class="table table--compact sortable">
            <thead>
              <tr>
                <th class="col-narrow">Feedback</th>
                <th data-type="text">Vibe Name</th>
                <th data-type="text">Vibe Artist</th>
                <th class="col-narrow" data-type="date">Submitted On</th>
              </tr>
            </thead>
            <tbody>
              {% for submission in previous_submissions %}
                <tr>
                  <td class="actions-cell">
                    {% if submission.submitter_id != user_id or testing_mode %}
                      <form action="{{ url_for('submit_feedback') }}" method="POST" class="action-row">
                        <input type="hidden" name="song_id" value="{{ submission.submission_id }}">
                        <button type="submit" name="feedback" value="like"
                                class="icon-button sm {% if submission.user_feedback == 'like' %}active{% endif %}"
                                title="Like" aria-label="Like">üëç</button>
                        <button type="submit" name="feedback" value="dislike"
                                class="icon-button sm {% if submission.user_feedback == 'dislike' %}active{% endif %}"
                                title="Dislike" aria-label="Dislike">üëé</button>
                      </form>
                    {% else %}
                      <span class="subtle">‚Äî</span>
                    {% endif %}
                  </td>
                  <td>
                      {% if submission.spotify_track_id %}
                        <a href="https://open.spotify.com/track/{{ submission.spotify_track_id }}" class="track-link" target="_blank" rel="noopener noreferrer">
                          {{ submission.track_name or "Unknown Title" }}
                        </a>
                      {% else %}
                        <span class="truncate">{{ submission.track_name or "Unknown Title" }}</span>
                      {% endif %}
                  </td>
                  <td><span class="truncate">{{ submission.track_artist or "Unknown Artist" }}</span></td>
                  <td class="nowrap"
                      data-sort="{{ submission.submitted_at.isoformat() if submission.submitted_at else '' }}">
                    {{ submission.submitted_at | to_est | datetimeformat('%b %d, %Y %I:%M %p') }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="subtle">üïê No drops yet ‚Äî check back after the next deadline.</p>
      {% endif %}
    </section>

    <div class="row" style="justify-content:flex-start;">
      <a class="btn link" href="{{ url_for('dashboard') }}">‚¨ÖÔ∏è Back to Profile</a>
    </div>

  {% if testing_mode %}
    <p class="subtle">üß™ Testing Mode Enabled ‚Äî showing submissions regardless of deadline.</p>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
  {% if previous_submissions %}
    <script>
      async function createPlaylist() {
        try {
          const response = await fetch("{{ url_for('create_playlist', circle_id=circle.id) }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          if (!response.ok) {
            let err = "Something went wrong.";
            try {
              const data = await response.json();
              if (data && data.error) err = data.error;
            } catch {}
            alert(err);
            return;
          }
          const data = await response.json();

          if (data && data.playlist_url) {
            // Open the web version of Spotify (works everywhere)
            window.open(data.playlist_url, "_blank", "noopener");
          } else if (data && data.playlist_uri) {
            // Fallback: attempt to open the Spotify app
            window.location.href = data.playlist_uri;
          } else {
            alert("Playlist created, but no Spotify link returned.");
          }
        } catch (e) {
          alert("Network error creating playlist.");
        }
      }
    </script>
  {% endif %}
  <script>
      function copyInviteCode() {
        const el = document.getElementById('invite-code');
        if (!el) return;
        const text = (el.textContent || el.innerText || '').trim();
    
        const flash = () => {
          el.classList.add('flash');
          setTimeout(() => el.classList.remove('flash'), 900);
        };
    
        const fallback = () => {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.top = '-9999px';
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          try { document.execCommand('copy'); } catch (e) {}
          document.body.removeChild(ta);
          flash();
        };
    
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(flash).catch(fallback);
        } else {
          fallback();
        }
      }
  </script>
  <script>
      (function(){
        const btn = document.getElementById('toggle-edit-members');
        const section = document.getElementById('members-section');
        if (!btn || !section) return;
    
        const labels = {
          off: 'Edit members',
          on:  'Cancel editing'
        };
    
        function updateUI(editing){
          section.classList.toggle('editing', editing);
          btn.setAttribute('aria-pressed', editing ? 'true' : 'false');
          btn.textContent = editing ? labels.on : labels.off;
        }
    
        let editing = false;
        btn.addEventListener('click', () => {
          editing = !editing;
          updateUI(editing);
        });
    
        // start hidden
        updateUI(false);
      })();
  </script>
{% endblock %}