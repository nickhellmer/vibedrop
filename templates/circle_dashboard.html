{% extends "base.html" %}
{% block title %}{{ circle.circle_name }} - VibeDrop{% endblock %}

{% block content %}

<div class="stack">

  <!-- NEXT DROP / META -->
  <section class="card">
    <div class="stack">
      <div class="row" style="justify-content: space-between;">
        <div class="stack">
          <p class="subtle" style="margin:0;">
            <strong>Drop Frequency:</strong> {{ circle.drop_frequency }}
          </p>
          <p class="subtle" style="margin:0;">
            <strong>Drop Time:</strong>
            {{ circle.drop_time | to_est | datetimeformat('%I:%M %p EST') }}
          </p>

          {% if circle.drop_frequency == 'Weekly' %}
            <p class="subtle" style="margin:0;"><strong>Drop Day:</strong> {{ circle.drop_day1 }}</p>
          {% elif circle.drop_frequency == 'Biweekly' %}
            <p class="subtle" style="margin:0;"><strong>Drop Days:</strong> {{ circle.drop_day1 }} &amp; {{ circle.drop_day2 }}</p>
          {% endif %}
          <p class="subtle" style="margin:0;"><strong>Invite Code:</strong> {{ circle.invite_code }}</p>
        </div>

        <div class="row">
          <a class="btn ghost" href="{{ url_for('submit_song', circle_id=circle.id) }}">üéµ Submit a Vibe</a>
          {% if previous_submissions %}
            <button type="button" class="btn ghost" onclick="createPlaylist()">Create & Open Playlist in Spotify</button>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <!-- MEMBERS -->
  <section class="card">
    <h2 class="h2-tight">Members</h2>
    {% if members and members|length > 0 %}
      <div class="table-viewport">
        <table class="table table--compact">
          <thead>
            <tr>
              <th>Username</th>
              <th class="col-narrow">Submitted This Cycle?</th>
            </tr>
          </thead>
          <tbody>
            {% for member in members %}
              <tr>
                <td>{{ member.vibedrop_username }}</td>
                <td>
                  {% if member.id in submitted_user_ids %}
                    ‚úÖ
                  {% else %}
                    ‚ùå
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="subtle">No members yet.</p>
    {% endif %}
  </section>

  <!-- TESTING-MODE SUBMISSIONS (current cycle, visible only in testing mode) -->
  {% if testing_mode %}
    <section class="card">
      <div class="row" style="justify-content: space-between; align-items: baseline;">
        <h2 style="h2-tight;">Submitted Vibes (Testing Mode Only)</h2>
      </div>

      {% if submissions %}
        <div class="table-viewport">
          <table class="table table--compact">
            <thead>
              <tr>
                <th>Vibe Name</th>
                <th>Vibe Artist</th>
                <th class="col-narrow">Submitted On</th>
              </tr>
            </thead>
            <tbody>
              {% for submission in submissions %}
                <tr>
                  <td><span class="truncate">{{ submission.track_name or "Unknown Title" }}</span></td>
                  <td><span class="truncate">{{ submission.track_artist or "Unknown Artist" }}</span></td>
                  <td>{{ submission.submitted_at | to_est | datetimeformat('%b %d, %Y at %I:%M %p EST') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="subtle">No submissions yet.</p>
      {% endif %}
    </section>
  {% endif %}



    <!-- FRESH FROM THE DROP (rate last finalized cycle) -->
    <section class="card">
      <div class="row" style="justify-content: space-between; align-items: baseline;">
        <h2 class="h2-tight">Fresh From the Drop</h2>
        {% if previous_submissions %}
          <button type="button" class="btn" onclick="createPlaylist()">Create & Open Playlist in Spotify</button>
        {% endif %}
      </div>
    
      {% if previous_submissions %}
        <div class="table-viewport" style="margin-top:10px;">
          <table class="table table--compact">
            <thead>
              <tr>
                <th class="col-narrow">Feedback</th>
                <th>Vibe Name</th>
                <th>Vibe Artist</th>
                <th class="col-narrow">Submitted On</th>
              </tr>
            </thead>
            <tbody>
              {% for submission in previous_submissions %}
                <tr>
                  <td class="actions-cell">
                      {% if submission.submitter_id != user_id or testing_mode %}
                        <form action="{{ url_for('submit_feedback') }}" method="POST" class="row">
                          <input type="hidden" name="song_id" value="{{ submission.submission_id }}">
                          <button type="submit" name="feedback" value="like"
                                  class="icon-button sm {% if submission.user_feedback == 'like' %}active{% endif %}"
                                  title="Like" aria-label="Like">üëç</button>
                          <button type="submit" name="feedback" value="dislike"
                                  class="icon-button sm {% if submission.user_feedback == 'dislike' %}active{% endif %}"
                                  title="Dislike" aria-label="Dislike">üëé</button>
                        </form>
                      {% else %}
                        <span class="subtle">‚Äî</span>
                      {% endif %}
                  </td>
                  <td><span class="truncate">{{ submission.track_name or "Unknown Title" }}</span></td>
                  <td><span class="truncate">{{ submission.track_artist or "Unknown Artist" }}</span></td>
                  <td class="nowrap">{{ submission.submitted_at | to_est | datetimeformat('%b %d, %Y %I:%M %p') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="subtle">üïê No drops yet ‚Äî check back after the next deadline.</p>
      {% endif %}
    </section>

  <div class="row" style="justify-content:flex-start;">
    <a class="btn ghost" href="{{ url_for('dashboard') }}">‚¨ÖÔ∏è Back to Profile</a>
  </div>

  {% if testing_mode %}
    <p class="subtle">üß™ Testing Mode Enabled ‚Äî showing submissions regardless of deadline.</p>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
  {% if previous_submissions %}
    <script>
      async function createPlaylist() {
        try {
          const response = await fetch("{{ url_for('create_playlist', circle_id=circle.id) }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          if (!response.ok) {
            let err = "Something went wrong.";
            try {
              const data = await response.json();
              if (data && data.error) err = data.error;
            } catch {}
            alert(err);
            return;
          }
          const data = await response.json();
          if (data && data.spotify_url) {
            window.open(data.spotify_url, "_blank", "noopener");
          } else {
            alert("Playlist created, but no Spotify link returned.");
          }
        } catch (e) {
          alert("Network error creating playlist.");
        }
      }
    </script>
  {% endif %}
{% endblock %}