{% extends "base.html" %}
{% block title %}All Users — VibeDrop{% endblock %}

{% block content %}

<div class="topbar">
  <h1 class="page-title">All Users</h1>
</div>

<section class="card flex">
  <h2 class="h2-tight">Community</h2>

  <!-- Scrollable, adaptive-height table -->
  <div class="table-viewport flex grow">
    <table class="table table--compact sortable" id="users-table">
      <thead>
        <tr>
          <th data-type="text">VibeDrop Username</th>
          <th class="col-narrow" data-type="number">Drop Cred</th>
          <th class="col-narrow" data-type="number">Submissions</th>
          <th class="col-narrow" data-type="number">Days Since Joining</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users_stats %}
        <tr>
          <td><span class="truncate">{{ u.vibedrop_username }}</span></td>
          <td class="nowrap">{{ u.drop_cred or 0 }}</td>
          <td class="nowrap">{{ u.submission_count or 0 }}</td>
          <!-- days since joining computed below; keep ISO for calc/sort -->
          <td class="nowrap" data-joined="{{ (u.created_at|to_est|datetimeformat('%Y-%m-%d')) if u.created_at else '' }}">—</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- Actions -->
<div class="row" style="margin-top:12px;">
  <a class="btn link" href="{{ url_for('dashboard') }}">⬅️ Back to Profile</a>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Fill "Days Since Joining" from data-joined and provide sort values.
  (function(){
    const table = document.getElementById('users-table');
    if (!table) return;

    const today = new Date(); today.setHours(0,0,0,0);

    table.querySelectorAll('tbody td[data-joined]').forEach(td => {
      const iso = td.getAttribute('data-joined');
      if (!iso) { td.textContent = '—'; td.setAttribute('data-sort',''); return; }
      const joined = new Date(iso + 'T00:00:00');
      if (isNaN(joined)) { td.textContent = '—'; td.setAttribute('data-sort',''); return; }
      const days = Math.max(0, Math.round((today - joined) / 86400000));
      td.textContent = String(days);
      td.setAttribute('data-sort', String(days)); // plays nice with base sorter
    });

    // Optional: default sort by Drop Cred (2nd column, index 1) desc
    const ths = table.tHead?.rows[0]?.cells || [];
    if (ths[1]) ths[1].click(); // first click = asc, do two for desc
    if (ths[1]) ths[1].click();
  })();
</script>
{% endblock %}