{% extends "base.html" %}
{% block title %}Account Settings - VibeDrop{% endblock %}

{% block extra_css %}
<style>
  /* Page-local helpers */
  .section-title { margin: 0 0 8px; }
  .w-100 { width:100%; }
  .kv-note { color: var(--muted); font-size: .9rem; }
  .form-narrow { max-width: 640px; }

  /* ---- My Sound Circles table (fit-without-scroll) ---- */

  /* Use fixed layout so widths are respected and text can ellipsize */
  #circles-table { table-layout: fixed; width: 100%; }

  /* First column: allow shrink + ellipsis */
  #circles-table th:first-child,
  #circles-table td:first-child {
    width: auto;                 /* flexible */
  }
  /* Second column (actions): small, never wraps */
  #circles-table th:last-child,
  #circles-table td:last-child {
    width: 110px;                /* fits the "Leave" button comfortably */
    white-space: nowrap;
    text-align: center;
  }

  /* Ensure the NAME cell actually truncates */
  #circles-table td.circle-name {
    overflow: hidden;            /* critical for ellipsis */
  }
  #circles-table td.circle-name .truncate {
    display: block;
    width: 100%;                 /* use full cell width */
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Tighten the Leave button in-table */
  #circles-table .actions-cell .btn {
    padding: 4px 10px;
    font-size: 0.85rem;
  }

  /* Kill horizontal scroll in the viewport entirely */
  .table-viewport { overflow-x: hidden; }

  /* Clamp height so short screens don’t blow up the cap */
  @media (max-width: 768px){
    .table-viewport.flex.grow {
      max-height: max(200px, calc(100vh - 340px)) !important;
    }
  }
</style>
{% endblock %}

{% block content %}

<div class="topbar">
  <h1 class="page-title">Account Settings</h1>
</div>

<div class="stack">

  <!-- PROFILE / CONTACT -->
  <section class="card">
    <h2 class="h2-tight section-title">Profile</h2>
    <form method="POST" action="/account-settings" class="stack form-narrow" novalidate>
      <div class="form-row">
        <div>
          <label for="new_username">Username</label>
          <input id="new_username" name="new_username" type="text"
                 class="form-control"
                 value="{{ user.vibedrop_username }}"
                 required minlength="3" maxlength="24" pattern="^[A-Za-z0-9_\.]+$">
        </div>
        <div>
          <label for="display_name">Spotify Display Name</label>
          <input id="display_name" type="text" class="form-control" value="{{ user.display_name or '—' }}" readonly>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="email">Email</label>
          <input id="email" name="email" type="email" class="form-control" value="{{ user.email or '' }}" required>
        </div>
        <div>
          <label for="phone_number">Phone Number</label>
          <input id="phone_number" name="phone_number" type="text" class="form-control"
                 placeholder="+1 (555) 123-4567" value="{{ user.phone_number or '' }}">
        </div>
      </div>

      <label class="row" style="gap:8px; align-items:center; margin-top:4px;">
        <input type="checkbox" name="sms_notifications" {% if user.sms_notifications %}checked{% endif %}>
        <span>Enable SMS reminders</span>
      </label>

      <div class="row" style="margin-top:8px;">
        <button type="submit" class="btn sm">Save Changes</button>
      </div>
    </form>
  </section>

  <!-- MEMBERSHIPS -->
  <section class="card flex">
      <h2 class="h2-tight section-title">My Sound Circles</h2>
    
      {% if user.circle_memberships %}
        <div class="table-viewport flex grow" style="max-height: max(220px, calc(100vh - 420px)); overflow:auto;">
          <table class="table table--compact sortable" id="circles-table">
            <thead>
              <tr>
                <th data-type="text">Circle Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for membership in user.circle_memberships %}
                <tr>
                  <td class="circle-name">
                    <span class="truncate">{{ membership.circle.circle_name }}</span>
                  </td>
                  <td class="actions-cell">
                    <form method="POST" action="/leave_circle"
                          onsubmit="return confirm('Leave {{ membership.circle.circle_name }}?');" style="margin:0;">
                      <input type="hidden" name="circle_id" value="{{ membership.circle.id }}">
                      <button type="submit" class="btn ghost danger xs">Leave</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="subtle">You are not currently in any Sound Circles.</p>
      {% endif %}
  </section>

  <!-- DANGER ZONE -->
  <section class="card">
    <h2 class="h2-tight section-title" style="color: var(--danger);">Danger Zone</h2>
    <p class="subtle" style="margin:0 0 8px;">Deleting your account is permanent.</p>
    <form method="POST" action="/delete-account"
          onsubmit="return confirm('Are you sure you want to delete your account? This cannot be undone.');">
      <button type="submit" class="btn ghost danger sm">Delete My Account</button>
    </form>
  </section>

  <div class="row">
    <a class="btn link" href="{{ url_for('dashboard') }}">⬅️ Back to Profile</a>
  </div>

</div>
{% endblock %}